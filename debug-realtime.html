<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Temps RÃ©el - Demon Spin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
        }

        .debug-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100vh;
        }

        .widget-panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            color: #333;
        }

        .debug-panel {
            background: #2d2d2d;
            border-radius: 16px;
            padding: 20px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }

        .debug-header {
            background: #38767d;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .debug-output {
            background: #1e1e1e;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-info { color: #61dafb; }
        .log-success { color: #98fb98; }
        .log-warning { color: #ffa500; }
        .log-error { color: #ff6b6b; }
        .log-data { color: #f0e68c; background: #2a2a2a; padding: 8px; }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .debug-btn {
            background: #38767d;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .debug-btn:hover {
            background: #4a8b92;
            transform: translateY(-2px);
        }

        .debug-btn.active {
            background: #e67e22;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            background: #38767d;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-btn.active {
            background: #e67e22;
        }

        .status-panel {
            background: #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .status-value {
            color: #98fb98;
            font-weight: bold;
        }

        /* Styles pour le widget Bsport */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #38767d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <!-- Panel Widget -->
        <div class="widget-panel">
            <div class="debug-header">
                <h2>ğŸ¯ Widget Bsport - Test Temps RÃ©el</h2>
            </div>

            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">ğŸ¢ Toutes les salles</button>
                <button class="filter-btn" data-filter="plessis-pole">ğŸ’ƒ Plessis - Pole</button>
                <button class="filter-btn" data-filter="plessis-aerial">ğŸª Plessis - Aerial</button>
                <button class="filter-btn" data-filter="saint-fargeau">ğŸ›ï¸ Saint-Fargeau</button>
            </div>

            <div class="status-panel">
                <div class="status-item">
                    <span>Statut Widget:</span>
                    <span class="status-value" id="widgetStatus">Initialisation...</span>
                </div>
                <div class="status-item">
                    <span>Filtre Actif:</span>
                    <span class="status-value" id="activeFilter">Toutes les salles</span>
                </div>
                <div class="status-item">
                    <span>RequÃªtes RÃ©seau:</span>
                    <span class="status-value" id="establishmentsCount">0 requÃªtes</span>
                </div>
            </div>

            <!-- Widget Bsport -->
            <div id="bsport-widget-debug">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement du widget Bsport...</p>
                </div>
            </div>
        </div>

        <!-- Panel Debug -->
        <div class="debug-panel">
            <div class="debug-header">
                <h2>ğŸ” Console Debug - Temps RÃ©el</h2>
            </div>

            <div class="control-panel">
                <button class="debug-btn" onclick="runManualAnalysis()">ğŸ” Analyse Manuelle</button>
                <button class="debug-btn" onclick="clearDebugOutput()">ğŸ—‘ï¸ Vider Console</button>
                <button class="debug-btn" onclick="exportResults()">ğŸ“‹ Exporter RÃ©sultats</button>
                <button class="debug-btn" id="autoAnalysisBtn" onclick="toggleAutoAnalysis()">âš¡ Auto-Analyse OFF</button>
                <button class="debug-btn" onclick="testFilterClick()">ğŸ§ª Test Clic Filtre</button>
                <button class="debug-btn" onclick="testButtonEvents()">ğŸ” Test Ã‰vÃ©nements</button>
                <button class="debug-btn" onclick="forceReloadWidget()">ğŸ”„ Force Reload</button>
                <button class="debug-btn" onclick="testSimpleFilter()">ğŸ§ª Test Simple</button>
                <button class="debug-btn" onclick="testNetworkRequests()">ğŸŒ Test RÃ©seau</button>
                <button class="debug-btn" onclick="monitorNetworkActivity()">ğŸ‘ï¸ Surveiller RÃ©seau</button>
                <button class="debug-btn" onclick="resetCounters()">ğŸ”„ Reset Compteurs</button>
                <button class="debug-btn" onclick="testUltraReload()">ğŸ’¥ Ultra Reload</button>
                <button class="debug-btn" onclick="inspectWidget()">ğŸ” Inspecter Widget</button>
                <button class="debug-btn" onclick="testAllFilters()">ğŸ¯ Test Tous Filtres</button>
                <button class="debug-btn" onclick="testClientSideFilter()">ğŸ¨ Filtre Client</button>
                <button class="debug-btn" onclick="analyzeWidgetContent()">ğŸ”¬ Analyser Contenu</button>
                <button class="debug-btn" onclick="highlightElements()">ğŸ¨ Surligner Ã‰lÃ©ments</button>
                <button class="debug-btn" onclick="stopWidgetObserver()">ğŸ‘ï¸ ArrÃªter Observateur</button>
                <button class="debug-btn" onclick="startWidgetObserver()">ğŸ‘ï¸ DÃ©marrer Observateur</button>
            </div>

            <div class="debug-output" id="debugOutput">
                <div class="log-entry log-info">ğŸš€ Debug temps rÃ©el initialisÃ©...</div>
                <div class="log-entry log-info">ğŸ”§ En attente du chargement de BsportWidget...</div>
            </div>
        </div>
    </div>

    <!-- Scripts Bsport -->
    <script id="insert-bsport-widget-cdn">
        !function (b, s, p, o, r, t) { 
            !typeof window.BsportWidget !== "undefined" && !document.getElementById("bsport-widget-cdn") && !function () { 
                m = b.createElement(s), m.id = "bsport-widget-cdn", m.src = p, b.getElementsByTagName("head")[0].appendChild(m) 
            }() 
        }(document, "script", "https://cdn.bsport.io/scripts/widget.js")
    </script>

    <script>
        // === SYSTÃˆME DE DEBUG TEMPS RÃ‰EL ===
        
        let debugOutput = null;
        let establishmentsFound = [];
        let isAutoAnalysis = false;
        let currentFilter = 'all';
        let networkRequestCount = 0;
        let lastRequestTime = null;
        let previousWidgetContent = '';
        let isReloading = false; // Ajout pour Ã©viter les boucles infinies

        // Configuration des salles avec IDs rÃ©els trouvÃ©s
        const sallesConfig = {
            all: {
                name: "Toutes les salles",
                establishments: []
            },
            "plessis-pole": {
                name: "Le Plessis - Pole Dance", 
                establishments: [1697] // âœ… ID trouvÃ©
            },
            "plessis-aerial": {
                name: "Le Plessis - Aerial Hoop",
                establishments: [2421] // âœ… ID trouvÃ©
            },
            "saint-fargeau": {
                name: "Saint-Fargeau-Ponthierry",
                establishments: [12450] // âœ… ID trouvÃ©
            }
        };

        // Configuration du widget Bsport
        const widgetConfig = {
            "parentElement": "bsport-widget-debug",
            "companyId": 553,
            "franchiseId": null,
            "dialogMode": 1,
            "widgetType": "calendar", 
            "showFab": false,
            "fullScreenPopup": false,
            "styles": undefined,
            "config": {
                "calendar": {
                    "groupSessionByPeriod": false,
                    "variant": "activityName",
                    "todayOnly": false,
                    "compactMode": false,
                    "establishments": []
                }
            }
        };

        // Fonction pour afficher les logs dans l'interface
        function addDebugLog(message, type = 'info') {
            if (!debugOutput) return;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            
            debugOutput.appendChild(logEntry);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        function addDebugData(title, data, type = 'data') {
            if (!debugOutput) return;
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>${title}:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            debugOutput.appendChild(logEntry);
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }

        // Compteur de requÃªtes pour vÃ©rifier l'activitÃ© (variables dÃ©jÃ  dÃ©clarÃ©es plus haut)

        // Interception des requÃªtes rÃ©seau
        function setupNetworkInterception() {
            addDebugLog('ğŸŒ Configuration de l\'interception rÃ©seau...', 'info');

            // Intercepter XMLHttpRequest
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                const originalSend = xhr.send;
                
                xhr.open = function(method, url, ...args) {
                    if (url.includes('bsport.io') || url.includes('bsport')) {
                        networkRequestCount++;
                        lastRequestTime = Date.now();
                        addDebugLog(`ğŸ“¡ XHR #${networkRequestCount} interceptÃ©e: ${method} ${url}`, 'info');
                        updateStatus('establishmentsCount', `${networkRequestCount} requÃªtes`);
                    }
                    return originalOpen.apply(this, [method, url, ...args]);
                };
                
                xhr.send = function(data) {
                    if (xhr._url && xhr._url.includes('bsport')) {
                        xhr.addEventListener('load', function() {
                            try {
                                const responseData = JSON.parse(xhr.responseText);
                                addDebugLog('ğŸ“Š RÃ©ponse XHR reÃ§ue', 'success');
                                
                                // Analyser les Ã©tablissements
                                analyzeResponseData(responseData);
                                
                            } catch (e) {
                                addDebugLog('ğŸ“„ RÃ©ponse XHR non-JSON', 'warning');
                            }
                        });
                    }
                    return originalSend.apply(this, arguments);
                };
                
                return xhr;
            };

            // Intercepter Fetch
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string' && (url.includes('bsport.io') || url.includes('bsport'))) {
                    networkRequestCount++;
                    lastRequestTime = Date.now();
                    addDebugLog(`ğŸ“¡ FETCH #${networkRequestCount} interceptÃ©e: ${url}`, 'info');
                    updateStatus('establishmentsCount', `${networkRequestCount} requÃªtes`);
                }
                
                return originalFetch.apply(this, args).then(response => {
                    if (typeof url === 'string' && (url.includes('bsport.io') || url.includes('bsport'))) {
                        response.clone().json().then(data => {
                            addDebugLog('ğŸ“Š RÃ©ponse FETCH reÃ§ue', 'success');
                            analyzeResponseData(data);
                        }).catch(() => {
                            addDebugLog('ğŸ“„ RÃ©ponse FETCH non-JSON', 'warning');
                        });
                    }
                    return response;
                });
            };
        }

        // Analyser les donnÃ©es de rÃ©ponse
        function analyzeResponseData(data) {
            // Chercher les Ã©tablissements
            if (data.establishments) {
                addDebugLog(`ğŸ¢ ${data.establishments.length} Ã©tablissement(s) trouvÃ©(s)!`, 'success');
                data.establishments.forEach((est, index) => {
                    const info = `ID: ${est.id}, Nom: ${est.name || est.label || 'Sans nom'}`;
                    addDebugLog(`  ${index + 1}. ${info}`, 'success');
                    
                    if (!establishmentsFound.find(e => e.id === est.id)) {
                        establishmentsFound.push(est);
                    }
                });
                updateEstablishmentsCount();
            }

            // Chercher dans les donnÃ©es imbriquÃ©es
            if (data.data && data.data.establishments) {
                addDebugData('ğŸ¢ Ã‰tablissements (data)', data.data.establishments);
            }

            if (data.locations) {
                addDebugData('ğŸ“ Locations', data.locations);
            }

            if (data.sites) {
                addDebugData('ğŸ­ Sites', data.sites);
            }

            // Afficher toutes les donnÃ©es pour analyse
            if (Object.keys(data).length > 0) {
                addDebugData('ğŸ“‹ DonnÃ©es complÃ¨tes', data);
            }
        }

        // Analyse manuelle du DOM
        function runManualAnalysis() {
            addDebugLog('ğŸ” === DÃ‰BUT ANALYSE MANUELLE ===', 'info');
            
            const widget = document.getElementById('bsport-widget-debug');
            if (!widget) {
                addDebugLog('âŒ Widget non trouvÃ©', 'error');
                return;
            }

            addDebugLog('ğŸ“± Analyse du contenu du widget...', 'info');
            addDebugData('HTML du widget', widget.innerHTML.substring(0, 1000));
            addDebugData('Texte du widget', widget.textContent.substring(0, 500));

            // Chercher des Ã©lÃ©ments spÃ©cifiques
            const elements = widget.querySelectorAll('*');
            let foundElements = 0;

            elements.forEach(el => {
                // Chercher des data-attributes
                if (el.dataset) {
                    Object.keys(el.dataset).forEach(key => {
                        if (key.toLowerCase().includes('establishment') || 
                            key.toLowerCase().includes('location') ||
                            key.toLowerCase().includes('site')) {
                            addDebugLog(`ğŸ¯ Data attribute: ${key} = ${el.dataset[key]}`, 'success');
                            foundElements++;
                        }
                    });
                }
                
                // Chercher des textes avec noms de salles
                const text = el.textContent;
                if (text.length < 100 && (
                    text.includes('Plessis') || 
                    text.includes('Saint-Fargeau') || 
                    text.includes('Aerial') || 
                    text.includes('Pole') ||
                    text.includes('Demon Spin')
                )) {
                    addDebugLog(`ğŸ“ Texte d'Ã©tablissement: "${text}"`, 'success');
                    addDebugLog(`   Classes: ${el.className}`, 'info');
                    addDebugLog(`   ID: ${el.id}`, 'info');
                    foundElements++;
                }
            });

            // Analyser BsportWidget
            if (window.BsportWidget) {
                addDebugLog('ğŸ”§ Analyse de BsportWidget...', 'info');
                addDebugData('BsportWidget objet', window.BsportWidget);
            }

            // Analyser le storage
            addDebugLog('ğŸ’¾ Analyse du storage...', 'info');
            let storageItems = 0;
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.toLowerCase().includes('bsport')) {
                        addDebugLog(`  localStorage[${key}]: ${localStorage.getItem(key)}`, 'info');
                        storageItems++;
                    }
                }
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    if (key.toLowerCase().includes('bsport')) {
                        addDebugLog(`  sessionStorage[${key}]: ${sessionStorage.getItem(key)}`, 'info');
                        storageItems++;
                    }
                }
            } catch (e) {
                addDebugLog(`âŒ Erreur storage: ${e.message}`, 'error');
            }

            addDebugLog(`âœ… Analyse terminÃ©e: ${foundElements} Ã©lÃ©ments DOM, ${storageItems} items storage`, 'success');
        }

        // Fonctions utilitaires
        function clearDebugOutput() {
            if (debugOutput) {
                debugOutput.innerHTML = '<div class="log-entry log-info">ğŸ—‘ï¸ Console vidÃ©e</div>';
            }
        }

        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                establishmentsFound: establishmentsFound,
                logs: debugOutput ? debugOutput.textContent : 'Aucun log'
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            addDebugLog('ğŸ“‹ RÃ©sultats exportÃ©s', 'success');
        }

        function toggleAutoAnalysis() {
            isAutoAnalysis = !isAutoAnalysis;
            const btn = document.getElementById('autoAnalysisBtn');
            btn.textContent = `âš¡ Auto-Analyse ${isAutoAnalysis ? 'ON' : 'OFF'}`;
            btn.className = `debug-btn ${isAutoAnalysis ? 'active' : ''}`;
            
            if (isAutoAnalysis) {
                addDebugLog('âš¡ Auto-analyse activÃ©e', 'info');
                setInterval(() => {
                    if (isAutoAnalysis) runManualAnalysis();
                }, 5000);
            } else {
                addDebugLog('âš¡ Auto-analyse dÃ©sactivÃ©e', 'info');
            }
        }

        function updateStatus(key, value) {
            const element = document.getElementById(key);
            if (element) {
                element.textContent = value;
            }
        }

                 function updateEstablishmentsCount() {
            updateStatus('establishmentsCount', establishmentsFound.length);
        }

        // Fonction pour comparer le contenu du widget
        let widgetContentBeforeFilter = '';
        
        function saveWidgetContent() {
            const widget = document.getElementById('bsport-widget-debug');
            if (widget) {
                widgetContentBeforeFilter = widget.innerHTML;
                addDebugLog('ğŸ“¸ Contenu du widget sauvegardÃ© pour comparaison', 'info');
            }
        }

        function compareWidgetContent() {
            const widget = document.getElementById('bsport-widget-debug');
            if (widget && widgetContentBeforeFilter) {
                const currentContent = widget.innerHTML;
                const hasChanged = currentContent !== widgetContentBeforeFilter;
                
                addDebugLog(`ğŸ” Comparaison du contenu: ${hasChanged ? 'DIFFÃ‰RENT' : 'IDENTIQUE'}`, hasChanged ? 'success' : 'warning');
                
                if (!hasChanged) {
                    addDebugLog('âš ï¸ Le widget semble utiliser un cache!', 'warning');
                    addDebugLog('ğŸ’¡ Solutions: Force Reload ou attendre le cache expire', 'info');
                } else {
                    addDebugLog('âœ… Le filtrage a bien modifiÃ© le contenu!', 'success');
                }
                
                return hasChanged;
            }
            return false;
        }

        // Fonctions de test pour debug
        function testFilterClick() {
            addDebugLog('ğŸ§ª === TEST MANUEL DU FILTRAGE ===', 'info');
            addDebugLog('ğŸ”„ Test avec le filtre Pole Dance...', 'info');
            handleFilterClick('plessis-pole');
        }

        function resetCounters() {
            addDebugLog('ğŸ”„ === RESET DES COMPTEURS ===', 'info');
            networkRequestCount = 0;
            lastRequestTime = 0;
            establishmentsFound = [];
            widgetContentBeforeFilter = '';
            updateStatus('establishmentsCount', '0 requÃªtes');
            updateStatus('widgetStatus', 'Compteurs rÃ©initialisÃ©s');
            addDebugLog('âœ… Tous les compteurs ont Ã©tÃ© rÃ©initialisÃ©s', 'success');
        }

        function testButtonEvents() {
            addDebugLog('ğŸ” === TEST DES Ã‰VÃ‰NEMENTS DES BOUTONS ===', 'info');
            
            const buttons = document.querySelectorAll('.filter-btn');
            addDebugLog(`ğŸ“Š ${buttons.length} boutons trouvÃ©s`, 'info');
            
            buttons.forEach((btn, index) => {
                const filterKey = btn.getAttribute('data-filter');
                const buttonText = btn.textContent.trim();
                const hasEventListener = btn.onclick || btn._listeners || false;
                
                addDebugLog(`  ${index + 1}. "${buttonText}":`, 'info');
                addDebugLog(`     - data-filter: "${filterKey}"`, 'info');
                addDebugLog(`     - Classes: "${btn.className}"`, 'info');
                addDebugLog(`     - Ã‰vÃ©nements: ${hasEventListener ? 'AttachÃ©s' : 'VÃ©rification...'}`, 'info');
                
                // Test de clic programmatique
                btn.style.border = '3px solid red';
                setTimeout(() => {
                    btn.style.border = '';
                }, 2000);
            });
            
            // Test de la configuration
            addDebugLog('ğŸ“‹ Test de la configuration des salles:', 'info');
            Object.keys(sallesConfig).forEach(key => {
                const config = sallesConfig[key];
                addDebugLog(`  - ${key}: ${config.name} [${config.establishments.join(', ')}]`, 'info');
            });
        }

        function forceReloadWidget() {
            if (isReloading) {
                addDebugLog('âš ï¸ Un reload est dÃ©jÃ  en cours...', 'warning');
                return;
            }

            addDebugLog('ğŸ”„ === FORCE RELOAD MANUEL ===', 'info');
            const config = sallesConfig[currentFilter];
            if (config) {
                tryCompleteDestruction(config);
            } else {
                addDebugLog('âŒ Impossible de dÃ©terminer le filtre actuel', 'error');
            }
        }

        // Test simple sans reload complexe
        function testSimpleFilter() {
            addDebugLog('ğŸ§ª === TEST SIMPLE SANS DESTRUCTION ===', 'info');
            
            if (!window.BsportWidget) {
                addDebugLog('âŒ BsportWidget non disponible', 'error');
                return;
            }

            // Test avec le filtre Plessis-Pole
            const config = sallesConfig['plessis-pole'];
            addDebugLog(`ğŸ¯ Test avec: ${config.name}`, 'info');
            addDebugLog(`ğŸ“‹ Ã‰tablissements: [${config.establishments.join(', ')}]`, 'info');

            // Sauvegarder le contenu actuel
            saveWidgetContent();

            // Nouvelle config simple
            const testConfig = {
                "parentElement": "bsport-widget-debug",
                "companyId": 553,
                "franchiseId": null,
                "dialogMode": 1,
                "widgetType": "calendar",
                "showFab": false,
                "fullScreenPopup": false,
                "config": {
                    "calendar": {
                        "establishments": config.establishments,
                        "variant": "activityName",
                        "compactMode": false
                    }
                }
            };

            addDebugLog('ğŸ“‹ Config de test simple:', 'info');
            addDebugData('Test Config', testConfig);

            try {
                // Appel direct sans complexitÃ©
                window.BsportWidget.mount(testConfig);
                addDebugLog('âœ… Mount simple effectuÃ©', 'success');

                // VÃ©rifier aprÃ¨s 3 secondes
                setTimeout(() => {
                    const hasWorked = checkIfFilterWorked();
                    addDebugLog(`ğŸ” RÃ©sultat test simple: ${hasWorked ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, hasWorked ? 'success' : 'warning');
                    
                    if (!hasWorked) {
                        addDebugLog('ğŸ’¡ Le widget Bsport ne semble pas rÃ©agir aux remontages simples', 'info');
                        addDebugLog('ğŸ”„ Cela confirme un problÃ¨me de cache interne', 'warning');
                    }
                }, 3000);

            } catch (error) {
                addDebugLog(`âŒ Erreur test simple: ${error.message}`, 'error');
            }
        }

        // Ultra reload : destruction totale du script Bsport
        function testUltraReload() {
            addDebugLog('ğŸ’¥ === ULTRA RELOAD - DESTRUCTION SCRIPT ===', 'info');
            
            if (isReloading) {
                addDebugLog('âš ï¸ Reload dÃ©jÃ  en cours...', 'warning');
                return;
            }

            isReloading = true;

            try {
                // Ã‰tape 1: Sauvegarder le contenu
                saveWidgetContent();

                // Ã‰tape 2: Supprimer tous les scripts Bsport
                addDebugLog('ğŸ—‘ï¸ Suppression des scripts Bsport...', 'info');
                const bsportScripts = document.querySelectorAll('script[src*="bsport"], script[id*="bsport"]');
                addDebugLog(`ğŸ“„ ${bsportScripts.length} scripts Bsport trouvÃ©s`, 'info');
                bsportScripts.forEach(script => script.remove());

                // Ã‰tape 3: Nettoyer window.BsportWidget
                addDebugLog('ğŸ§¹ Nettoyage de window.BsportWidget...', 'info');
                delete window.BsportWidget;

                // Ã‰tape 4: Vider complÃ¨tement le widget
                const widgetElement = document.getElementById('bsport-widget-debug');
                if (widgetElement) {
                    widgetElement.innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Ultra Reload en cours...</p>
                            <small>Rechargement complet du script</small>
                        </div>
                    `;
                }

                // Ã‰tape 5: Recharger le script Bsport
                addDebugLog('ğŸ”„ Rechargement du script Bsport...', 'info');
                const newScript = document.createElement('script');
                newScript.src = 'https://cdn.bsport.io/scripts/widget.js';
                newScript.id = 'bsport-widget-cdn-reload';
                
                newScript.onload = function() {
                    addDebugLog('âœ… Script Bsport rechargÃ©', 'success');
                    
                    // Attendre que BsportWidget soit disponible
                    let retries = 0;
                    const checkBsport = () => {
                        retries++;
                        if (window.BsportWidget) {
                            addDebugLog('âœ… BsportWidget dÃ©tectÃ© aprÃ¨s rechargement', 'success');
                            
                            // Remonter avec le filtre actuel
                            setTimeout(() => {
                                const config = sallesConfig['plessis-pole']; // Test avec Plessis-Pole
                                const newConfig = {...widgetConfig};
                                newConfig.config.calendar.establishments = config.establishments;
                                newConfig._ultraReload = Date.now();

                                addDebugLog('ğŸš€ Remontage aprÃ¨s ultra reload...', 'info');
                                addDebugData('Ultra Config', newConfig);
                                
                                window.BsportWidget.mount(newConfig);
                                addDebugLog('âœ… Ultra reload terminÃ©', 'success');
                                
                                isReloading = false;

                                // VÃ©rifier le rÃ©sultat
                                setTimeout(() => {
                                    const hasWorked = checkIfFilterWorked();
                                    addDebugLog(`ğŸ” RÃ©sultat ultra reload: ${hasWorked ? 'SUCCÃˆS' : 'Ã‰CHEC'}`, hasWorked ? 'success' : 'error');
                                    
                                    if (!hasWorked) {
                                        addDebugLog('ğŸ’€ Ultra reload a Ã©chouÃ© - Le cache est au niveau serveur/CDN', 'error');
                                        addDebugLog('ğŸ’¡ Solutions possibles:', 'info');
                                        addDebugLog('   1. Changer de companyId temporairement', 'info');
                                        addDebugLog('   2. Utiliser une URL de widget diffÃ©rente', 'info');
                                        addDebugLog('   3. Le filtrage pourrait nÃ©cessiter une autre API', 'info');
                                    }
                                }, 3000);
                                
                            }, 1000);
                        } else if (retries < 20) {
                            setTimeout(checkBsport, 200);
                        } else {
                            addDebugLog('âŒ BsportWidget non disponible aprÃ¨s rechargement', 'error');
                            isReloading = false;
                        }
                    };
                    checkBsport();
                };

                newScript.onerror = function() {
                    addDebugLog('âŒ Erreur de rechargement du script', 'error');
                    isReloading = false;
                };

                document.head.appendChild(newScript);

            } catch (error) {
                addDebugLog(`âŒ Erreur ultra reload: ${error.message}`, 'error');
                isReloading = false;
            }
        }

        // Inspection dÃ©taillÃ©e du widget
        function inspectWidget() {
            addDebugLog('ğŸ” === INSPECTION DÃ‰TAILLÃ‰E DU WIDGET ===', 'info');
            
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) {
                addDebugLog('âŒ Ã‰lÃ©ment widget non trouvÃ©', 'error');
                return;
            }

            // Analyser la structure DOM
            addDebugLog(`ğŸ“ HTML Length: ${widgetElement.innerHTML.length}`, 'info');
            addDebugLog(`ğŸ“„ Text Content Length: ${widgetElement.textContent.length}`, 'info');
            
            // Chercher des Ã©lÃ©ments spÃ©cifiques
            const iframes = widgetElement.querySelectorAll('iframe');
            const forms = widgetElement.querySelectorAll('form');
            const calendars = widgetElement.querySelectorAll('[class*="calendar"], [class*="schedule"], [class*="planning"]');
            
            addDebugLog(`ğŸ–¼ï¸ IFrames trouvÃ©s: ${iframes.length}`, 'info');
            addDebugLog(`ğŸ“ Forms trouvÃ©s: ${forms.length}`, 'info');
            addDebugLog(`ğŸ“… Ã‰lÃ©ments calendrier: ${calendars.length}`, 'info');
            
            // Analyser les classes CSS
            const allElements = widgetElement.querySelectorAll('*');
            const classNames = new Set();
            allElements.forEach(el => {
                if (el.className && typeof el.className === 'string') {
                    el.className.split(' ').forEach(cls => {
                        if (cls.trim()) classNames.add(cls.trim());
                    });
                }
            });
            
            addDebugLog(`ğŸ¨ Classes CSS uniques: ${classNames.size}`, 'info');
            addDebugLog(`ğŸ“‹ Quelques classes: ${Array.from(classNames).slice(0, 10).join(', ')}`, 'info');
            
            // Chercher des indicateurs d'Ã©tablissement
            const textContent = widgetElement.textContent.toLowerCase();
            const establishments = ['plessis', 'pole', 'aerial', 'saint-fargeau', 'ponthierry'];
            const foundEstablishments = establishments.filter(est => textContent.includes(est));
            
            addDebugLog(`ğŸ¢ Ã‰tablissements dÃ©tectÃ©s dans le texte: ${foundEstablishments.length > 0 ? foundEstablishments.join(', ') : 'Aucun'}`, foundEstablishments.length > 0 ? 'success' : 'warning');
            
            // VÃ©rifier s'il y a des erreurs ou messages
            const errorElements = widgetElement.querySelectorAll('[class*="error"], [class*="warning"], [class*="empty"]');
            if (errorElements.length > 0) {
                addDebugLog(`âš ï¸ ${errorElements.length} Ã©lÃ©ments d'erreur/warning trouvÃ©s`, 'warning');
                errorElements.forEach((el, i) => {
                    addDebugLog(`   ${i+1}. ${el.textContent.substring(0, 100)}`, 'warning');
                });
            }
            
            // Ã‰chantillon du contenu
            const sample = widgetElement.textContent.substring(0, 300);
            addDebugLog(`ğŸ“– Ã‰chantillon du contenu:`, 'info');
            addDebugLog(`"${sample}${sample.length === 300 ? '...' : ''}"`, 'info');
        }

        // Test de tous les filtres en sÃ©quence
        function testAllFilters() {
            addDebugLog('ğŸ¯ === TEST DE TOUS LES FILTRES ===', 'info');
            
            const filters = Object.keys(sallesConfig);
            let currentIndex = 0;
            
            function testNextFilter() {
                if (currentIndex >= filters.length) {
                    addDebugLog('ğŸ Test de tous les filtres terminÃ©', 'success');
                    return;
                }
                
                const filterKey = filters[currentIndex];
                const config = sallesConfig[filterKey];
                
                addDebugLog(`ğŸ”„ Test ${currentIndex + 1}/${filters.length}: ${config.name}`, 'info');
                
                // Sauvegarder l'Ã©tat avant
                const beforeContent = document.getElementById('bsport-widget-debug')?.textContent || '';
                const beforeLength = beforeContent.length;
                
                // Appliquer le filtre
                const newConfig = {...widgetConfig};
                newConfig.config.calendar.establishments = config.establishments;
                newConfig._testSequence = currentIndex;
                
                try {
                    window.BsportWidget.mount(newConfig);
                    addDebugLog(`âœ… Mount ${filterKey} effectuÃ©`, 'success');
                    
                    // VÃ©rifier aprÃ¨s 2 secondes
                    setTimeout(() => {
                        const afterContent = document.getElementById('bsport-widget-debug')?.textContent || '';
                        const afterLength = afterContent.length;
                        const hasChanged = Math.abs(afterLength - beforeLength) > 50 || afterContent !== beforeContent;
                        
                        addDebugLog(`ğŸ“Š ${filterKey}: Avant=${beforeLength} chars, AprÃ¨s=${afterLength} chars, ChangÃ©=${hasChanged ? 'OUI' : 'NON'}`, hasChanged ? 'success' : 'warning');
                        
                        currentIndex++;
                        setTimeout(testNextFilter, 1000);
                    }, 2000);
                    
                } catch (error) {
                    addDebugLog(`âŒ Erreur ${filterKey}: ${error.message}`, 'error');
                    currentIndex++;
                    setTimeout(testNextFilter, 1000);
                }
            }
            
            // DÃ©marrer la sÃ©quence
            saveWidgetContent();
            testNextFilter();
        }

        // Analyse approfondie du contenu du widget
        function analyzeWidgetContent() {
            addDebugLog('ğŸ”¬ === ANALYSE DÃ‰TAILLÃ‰E DU CONTENU ===', 'info');
            
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) {
                addDebugLog('âŒ Widget non trouvÃ©', 'error');
                return;
            }

            // Chercher tous les Ã©lÃ©ments qui contiennent du texte
            const allTextElements = [];
            const walker = document.createTreeWalker(
                widgetElement,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            let node;
            while (node = walker.nextNode()) {
                if (node.textContent.trim().length > 2) {
                    allTextElements.push({
                        text: node.textContent.trim(),
                        parent: node.parentElement
                    });
                }
            }

            addDebugLog(`ğŸ“„ ${allTextElements.length} Ã©lÃ©ments texte trouvÃ©s`, 'info');

            // Chercher des mentions d'Ã©tablissements
            const establishments = {
                'plessis': [],
                'pole': [],
                'aerial': [],
                'saint-fargeau': [],
                'ponthierry': []
            };

            allTextElements.forEach((element, index) => {
                const text = element.text.toLowerCase();
                Object.keys(establishments).forEach(est => {
                    if (text.includes(est)) {
                        establishments[est].push({
                            index,
                            text: element.text,
                            element: element.parent
                        });
                    }
                });
            });

            // Afficher les rÃ©sultats
            Object.keys(establishments).forEach(est => {
                const count = establishments[est].length;
                addDebugLog(`ğŸ¢ "${est}": ${count} mentions trouvÃ©es`, count > 0 ? 'success' : 'info');
                
                if (count > 0 && count <= 5) {
                    establishments[est].forEach((item, i) => {
                        addDebugLog(`   ${i+1}. "${item.text.substring(0, 50)}..."`, 'info');
                    });
                }
            });

            // Chercher des patterns de cours/sessions
            const coursePatterns = [
                /\d{1,2}[h:]\d{2}/g, // Heures (ex: 18:30, 18h30)
                /lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche/gi, // Jours
                /janvier|fÃ©vrier|mars|avril|mai|juin|juillet|aoÃ»t|septembre|octobre|novembre|dÃ©cembre/gi, // Mois
                /\d{1,2}\/\d{1,2}/g, // Dates (ex: 15/01)
                /pole|aerial|hoop|lyra|tissu/gi // Types de cours
            ];

            let totalMatches = 0;
            coursePatterns.forEach((pattern, i) => {
                const matches = widgetElement.textContent.match(pattern) || [];
                totalMatches += matches.length;
                addDebugLog(`ğŸ“… Pattern ${i+1}: ${matches.length} matches`, 'info');
            });

            addDebugLog(`ğŸ“Š Total Ã©lÃ©ments de planning dÃ©tectÃ©s: ${totalMatches}`, 'info');

            // Stocker pour usage ultÃ©rieur
            window.widgetAnalysis = {
                establishments,
                allTextElements,
                totalMatches
            };

            addDebugLog('ğŸ’¾ Analyse stockÃ©e dans window.widgetAnalysis', 'success');
        }

        // Test de filtrage cÃ´tÃ© client
        function testClientSideFilter() {
            addDebugLog('ğŸ¨ === TEST FILTRAGE CÃ”TÃ‰ CLIENT ===', 'info');
            
            // D'abord analyser le contenu si pas encore fait
            if (!window.widgetAnalysis) {
                addDebugLog('ğŸ”¬ Analyse du contenu en cours...', 'info');
                analyzeWidgetContent();
                
                setTimeout(() => {
                    testClientSideFilter();
                }, 1000);
                return;
            }

            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) {
                addDebugLog('âŒ Widget non trouvÃ©', 'error');
                return;
            }

            // Test: masquer tous les Ã©lÃ©ments contenant "saint-fargeau"
            addDebugLog('ğŸ¯ Test: masquer les Ã©lÃ©ments "saint-fargeau"', 'info');
            
            const saintFargeauElements = window.widgetAnalysis.establishments['saint-fargeau'] || [];
            let hiddenCount = 0;

            saintFargeauElements.forEach(item => {
                if (item.element) {
                    // NOUVELLE LOGIQUE UNIFIÃ‰E - identique au surlignage
                    let elementToHide = item.element;
                    
                    // Strategy 1: Chercher spÃ©cifiquement les bs-week-card comme dans le surlignage
                    let attempts = 0;
                    while (elementToHide && elementToHide !== widgetElement && attempts < 10) {
                        const className = elementToHide.className || '';
                        const tagName = elementToHide.tagName || '';
                        
                        // PRIORITÃ‰ ABSOLUE: bs-week-card (c'est exactement ce que le surlignage trouve)
                        if (className.includes('bs-week-card')) {
                            addDebugLog(`âœ… TrouvÃ© bs-week-card pour "${item.text.substring(0, 30)}..."`, 'success');
                            break;
                        }
                        
                        elementToHide = elementToHide.parentElement;
                        attempts++;
                    }

                    if (elementToHide && elementToHide !== widgetElement) {
                        elementToHide.style.display = 'none';
                        elementToHide.setAttribute('data-hidden-by-filter', 'saint-fargeau');
                        hiddenCount++;
                        addDebugLog(`ğŸ‘» MasquÃ©: ${elementToHide.tagName}.${elementToHide.className}`, 'success');
                    }
                }
            });

            addDebugLog(`âœ… ${hiddenCount} Ã©lÃ©ments masquÃ©s`, hiddenCount > 0 ? 'success' : 'warning');
        }

        // Fonction pour restaurer tous les Ã©lÃ©ments masquÃ©s
        function restoreHiddenElements() {
            addDebugLog('ğŸ”„ Restauration des Ã©lÃ©ments masquÃ©s...', 'info');
            
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) return;

            // Restaurer les Ã©lÃ©ments masquÃ©s
            const hiddenElements = widgetElement.querySelectorAll('[data-hidden-by-filter]');
            hiddenElements.forEach(el => {
                el.style.display = '';
                el.removeAttribute('data-hidden-by-filter');
            });

            addDebugLog(`âœ… ${hiddenElements.length} Ã©lÃ©ments restaurÃ©s`, 'success');
        }

        // Fonction principale de gestion des clics
        function handleFilterClick(filterKey) {
            addDebugLog(`ğŸ–±ï¸ === CLIC BOUTON DÃ‰TECTÃ‰ ===`, 'info');
            addDebugLog(`ğŸ“‹ FilterKey reÃ§u: "${filterKey}"`, 'info');
            addDebugLog(`ğŸ“‹ Current filter: "${currentFilter}"`, 'info');

            const config = sallesConfig[filterKey];
            if (!config) {
                addDebugLog(`âŒ Configuration non trouvÃ©e pour: ${filterKey}`, 'error');
                return;
            }

            if (currentFilter === filterKey) {
                addDebugLog(`âš ï¸ Filtre dÃ©jÃ  actif: ${config.name}`, 'warning');
                return;
            }

            addDebugLog(`âœ… Configuration trouvÃ©e: ${config.name}`, 'success');

            // Mettre Ã  jour les boutons
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                const btnFilterKey = btn.getAttribute('data-filter');
                if (btnFilterKey === filterKey) {
                    btn.classList.add('active');
                    addDebugLog(`âœ… Bouton activÃ©: ${btn.textContent}`, 'success');
                }
            });

            // Mettre Ã  jour le statut
            try {
                updateStatus('activeFilter', config.name);
                addDebugLog(`ğŸ“Š Statut mis Ã  jour: ${config.name}`, 'success');
            } catch (error) {
                addDebugLog(`âŒ Erreur mise Ã  jour statut: ${error.message}`, 'error');
            }

            // Changer le filtre actuel
            currentFilter = filterKey;
            addDebugLog(`ğŸ”„ currentFilter mis Ã  jour: "${currentFilter}"`, 'success');

            // NOUVELLE APPROCHE: Filtrage cÃ´tÃ© client
            addDebugLog(`ğŸ¨ === DÃ‰BUT FILTRAGE CÃ”TÃ‰ CLIENT ===`, 'info');
            try {
                applyClientSideFilter(filterKey);
                addDebugLog(`ğŸ¨ applyClientSideFilter terminÃ© sans erreur`, 'success');
            } catch (error) {
                addDebugLog(`âŒ Erreur dans applyClientSideFilter: ${error.message}`, 'error');
            }

            addDebugLog(`ğŸ === FIN TRAITEMENT CLIC ===`, 'info');
        }

        // Fonction principale de filtrage cÃ´tÃ© client
        function applyClientSideFilter(filterKey) {
            addDebugLog(`ğŸ¨ Application du filtre cÃ´tÃ© client: ${filterKey}`, 'info');
            
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) {
                addDebugLog('âŒ Widget non trouvÃ©', 'error');
                return;
            }

            // D'abord restaurer tous les Ã©lÃ©ments
            restoreHiddenElements();

            if (filterKey === 'all') {
                addDebugLog('âœ… Filtre "Toutes les salles" - tous les Ã©lÃ©ments visibles', 'success');
                return;
            }

            // Analyser le contenu si nÃ©cessaire
            if (!window.widgetAnalysis) {
                addDebugLog('ğŸ”¬ Analyse du contenu nÃ©cessaire...', 'info');
                analyzeWidgetContent();
                
                setTimeout(() => {
                    applyClientSideFilter(filterKey);
                }, 1000);
                return;
            }

            // DÃ©finir quels Ã©tablissements masquer selon le filtre
            const filterMapping = {
                'plessis-pole': ['saint-fargeau', 'ponthierry', 'aerial'],
                'plessis-aerial': ['saint-fargeau', 'ponthierry', 'pole'],
                'saint-fargeau': ['plessis', 'pole', 'aerial']
            };

            const toHide = filterMapping[filterKey] || [];
            addDebugLog(`ğŸ¯ Masquage des Ã©tablissements: ${toHide.join(', ')}`, 'info');

            let totalHidden = 0;

            toHide.forEach(establishment => {
                const elements = window.widgetAnalysis.establishments[establishment] || [];
                
                elements.forEach(item => {
                    if (item.element) {
                        // Chercher spÃ©cifiquement bs-week-card d'abord
                        let elementToHide = item.element;
                        
                        let attempts = 0;
                        while (elementToHide && elementToHide !== widgetElement && attempts < 10) {
                            const className = elementToHide.className || '';
                            
                            if (className.includes('bs-week-card')) {
                                addDebugLog(`âœ… TrouvÃ© bs-week-card pour "${item.text.substring(0, 30)}..."`, 'success');
                                break;
                            }
                            
                            elementToHide = elementToHide.parentElement;
                            attempts++;
                        }

                        if (elementToHide && elementToHide !== widgetElement && elementToHide.className.includes('bs-week-card')) {
                            elementToHide.style.display = 'none';
                            elementToHide.setAttribute('data-hidden-by-filter', establishment);
                            totalHidden++;
                            
                            const height = elementToHide.offsetHeight || 0;
                            const width = elementToHide.offsetWidth || 0;
                            addDebugLog(`ğŸ‘» MasquÃ©: ${elementToHide.tagName}.${elementToHide.className} (${width}x${height}px)`, 'success');
                        }
                    }
                });
            });

            addDebugLog(`âœ… Filtrage terminÃ©: ${totalHidden} Ã©lÃ©ments masquÃ©s`, totalHidden > 0 ? 'success' : 'warning');

            // DÃ©marrer l'observation pour rÃ©appliquer le filtre si le contenu change
            startWidgetObserver();
        }

        // Variable pour stocker l'observateur
        let widgetObserver = null;
        let lastWidgetContent = '';

        // Fonction pour observer les changements dans le widget
        function startWidgetObserver() {
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) return;

            // ArrÃªter l'observateur prÃ©cÃ©dent s'il existe
            if (widgetObserver) {
                widgetObserver.disconnect();
            }

            // Sauvegarder le contenu actuel
            lastWidgetContent = widgetElement.innerHTML;

            // CrÃ©er un nouvel observateur
            widgetObserver = new MutationObserver((mutations) => {
                let contentChanged = false;

                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        contentChanged = true;
                    }
                });

                if (contentChanged) {
                    const newContent = widgetElement.innerHTML;
                    if (newContent !== lastWidgetContent && newContent.length > 1000) {
                        addDebugLog('ğŸ”„ Changement dÃ©tectÃ© dans le widget', 'info');
                        
                        lastWidgetContent = newContent;
                        
                        // RÃ©appliquer le filtre actuel aprÃ¨s un dÃ©lai
                        if (currentFilter !== 'all') {
                            addDebugLog(`ğŸ”„ RÃ©application du filtre: ${currentFilter}`, 'info');
                            
                            setTimeout(() => {
                                // RÃ©analyser le contenu car il a changÃ©
                                window.widgetAnalysis = null;
                                applyClientSideFilter(currentFilter);
                            }, 1500);
                        }
                    }
                }
            });

            // Commencer l'observation
            widgetObserver.observe(widgetElement, {
                childList: true,
                subtree: true
            });

            addDebugLog('ğŸ‘ï¸ Observateur du widget dÃ©marrÃ©', 'success');
        }

        // Fonction pour arrÃªter l'observateur
        function stopWidgetObserver() {
            if (widgetObserver) {
                widgetObserver.disconnect();
                widgetObserver = null;
                addDebugLog('ğŸ‘ï¸ Observateur du widget arrÃªtÃ©', 'info');
            }
        }

        // Section supprimÃ©e - fonctions nettoyÃ©es et reconstruites

        function analyzeWidgetContent() {
                    if (elementToHide === item.element || attempts >= 10 || !elementToHide.className.includes('bs-week-card')) {
                        addDebugLog(`ğŸ” Strategy 2: Recherche par taille pour "${item.text.substring(0, 30)}..."`, 'info');
                        
                        let current = item.element;
                        for (let level = 0; level < 8; level++) {
                            if (current && current.parentElement) {
                                current = current.parentElement;
                                
                                // Chercher un Ã©lÃ©ment plus grand (case complÃ¨te)
                                const height = current.offsetHeight || 0;
                                const width = current.offsetWidth || 0;
                                const className = current.className || '';
                                
                                // Taille minimale pour une case de planning complÃ¨te
                                if (height >= 60 && width >= 200) {
                                    elementToHide = current;
                                    addDebugLog(`âœ… TrouvÃ© conteneur par taille: ${height}x${width}px, classe: ${className}`, 'success');
                                    break;
                                }
                                
                                // Ou si c'est une classe spÃ©cifique mÃªme si plus petit
                                if (className.includes('bs-week-card') || className.includes('bs-offer')) {
                                    elementToHide = current;
                                    addDebugLog(`âœ… TrouvÃ© conteneur par classe: ${className}`, 'success');
                                    break;
                                }
                            }
                        }
                    }

                    // Strategy 3: Fallback - au minimum 60px de hauteur
                    if (elementToHide === item.element || (elementToHide.offsetHeight || 0) < 60) {
                        let parent = item.element.parentElement;
                        while (parent && parent !== widgetElement) {
                            if ((parent.offsetHeight || 0) >= 60 && (parent.offsetWidth || 0) >= 150) {
                                elementToHide = parent;
                                addDebugLog(`âœ… Fallback trouvÃ©: ${parent.offsetHeight}x${parent.offsetWidth}px`, 'info');
                                break;
                            }
                            parent = parent.parentElement;
                        }
                    }

                    if (elementToHide && elementToHide !== widgetElement) {
                        // VÃ©rifier la taille finale
                        const finalHeight = elementToHide.offsetHeight || 0;
                        const finalWidth = elementToHide.offsetWidth || 0;
                        const elementSize = finalHeight * finalWidth;
                        const widgetSize = widgetElement.offsetHeight * widgetElement.offsetWidth;
                        
                        // Ne masquer que si c'est assez grand pour Ãªtre une vraie case mais pas trop grand
                        if (finalHeight >= 50 && finalWidth >= 100 && elementSize < widgetSize * 0.8) {
                            elementToHide.style.display = 'none';
                            elementToHide.setAttribute('data-hidden-by-filter', establishment);
                            totalHidden++;
                            
                            addDebugLog(`ğŸ‘» MasquÃ©: ${elementToHide.tagName}.${elementToHide.className} (${finalWidth}x${finalHeight}px)`, 'success');
                        } else {
                            addDebugLog(`âš ï¸ Ã‰lÃ©ment ignorÃ© (trop petit ou trop grand): ${finalWidth}x${finalHeight}px`, 'warning');
                        }
                    } else {
                        addDebugLog(`âš ï¸ Impossible de trouver conteneur appropriÃ© pour: "${item.text.substring(0, 30)}..."`, 'warning');
                    }
                }
            });

            addDebugLog(`âœ… Filtrage terminÃ©: ${totalHidden} Ã©lÃ©ments masquÃ©s`, totalHidden > 0 ? 'success' : 'warning');

            if (totalHidden === 0) {
                addDebugLog('ğŸ’¡ Aucun Ã©lÃ©ment masquÃ© - le widget pourrait ne pas contenir de cours pour ces Ã©tablissements', 'info');
                addDebugLog('ğŸ” Ou la structure DOM ne permet pas le filtrage automatique', 'warning');
            }

            // NOUVEAU: DÃ©marrer l'observation pour rÃ©appliquer le filtre si le contenu change
            startWidgetObserver();
        }

        // Variable pour stocker l'observateur
        let widgetObserver = null;
        let lastWidgetContent = '';

        // Fonction pour observer les changements dans le widget
        function startWidgetObserver() {
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) return;

            // ArrÃªter l'observateur prÃ©cÃ©dent s'il existe
            if (widgetObserver) {
                widgetObserver.disconnect();
            }

            // Sauvegarder le contenu actuel
            lastWidgetContent = widgetElement.innerHTML;

            // CrÃ©er un nouvel observateur
            widgetObserver = new MutationObserver((mutations) => {
                let contentChanged = false;

                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        contentChanged = true;
                    }
                });

                if (contentChanged) {
                    const newContent = widgetElement.innerHTML;
                    if (newContent !== lastWidgetContent && newContent.length > 1000) {
                        addDebugLog('ğŸ”„ Changement dÃ©tectÃ© dans le widget (navigation semaine?)', 'info');
                        addDebugLog(`ğŸ“ Nouveau contenu: ${newContent.length} chars`, 'info');
                        
                        lastWidgetContent = newContent;
                        
                        // RÃ©appliquer le filtre actuel aprÃ¨s un dÃ©lai
                        if (currentFilter !== 'all') {
                            addDebugLog(`ğŸ”„ RÃ©application du filtre: ${currentFilter}`, 'info');
                            
                            setTimeout(() => {
                                // RÃ©analyser le contenu car il a changÃ©
                                window.widgetAnalysis = null;
                                applyClientSideFilter(currentFilter);
                            }, 1500); // DÃ©lai pour laisser le widget se stabiliser
                        }
                    }
                }
            });

            // Commencer l'observation
            widgetObserver.observe(widgetElement, {
                childList: true,
                subtree: true
            });

            addDebugLog('ğŸ‘ï¸ Observateur du widget dÃ©marrÃ©', 'success');
        }

        // Fonction pour arrÃªter l'observateur
        function stopWidgetObserver() {
            if (widgetObserver) {
                widgetObserver.disconnect();
                widgetObserver = null;
                addDebugLog('ğŸ‘ï¸ Observateur du widget arrÃªtÃ©', 'info');
            }
        }

        // Fonction pour surligner visuellement les Ã©lÃ©ments trouvÃ©s
        function highlightElements() {
            addDebugLog('ğŸ¨ === SURLIGNAGE DES Ã‰LÃ‰MENTS ===', 'info');
            
            if (!window.widgetAnalysis) {
                addDebugLog('ğŸ”¬ Analyse du contenu nÃ©cessaire...', 'info');
                analyzeWidgetContent();
                setTimeout(highlightElements, 1000);
                return;
            }

            const widgetElement = document.getElementById('bsport-widget-debug');
            if (!widgetElement) return;

            // Supprimer les anciens surlignages
            widgetElement.querySelectorAll('[data-highlighted]').forEach(el => {
                el.style.border = '';
                el.style.backgroundColor = '';
                el.removeAttribute('data-highlighted');
            });

            const colors = {
                'plessis': 'rgba(255, 0, 0, 0.3)', // Rouge
                'pole': 'rgba(0, 255, 0, 0.3)',    // Vert
                'aerial': 'rgba(0, 0, 255, 0.3)',  // Bleu
                'saint-fargeau': 'rgba(255, 255, 0, 0.3)', // Jaune
                'ponthierry': 'rgba(255, 0, 255, 0.3)'     // Magenta
            };

            Object.keys(window.widgetAnalysis.establishments).forEach(establishment => {
                const elements = window.widgetAnalysis.establishments[establishment] || [];
                const color = colors[establishment] || 'rgba(128, 128, 128, 0.3)';
                
                addDebugLog(`ğŸ¨ Surlignage "${establishment}": ${elements.length} Ã©lÃ©ments`, 'info');
                
                elements.forEach((item, index) => {
                    if (item.element) {
                        // Trouver l'Ã©lÃ©ment Ã  surligner avec la mÃªme logique que le masquage
                        let elementToHighlight = item.element;
                        
                        // MÃªme logique que dans applyClientSideFilter
                        let attempts = 0;
                        while (elementToHighlight && elementToHighlight !== widgetElement && attempts < 10) {
                            const className = elementToHighlight.className || '';
                            const tagName = elementToHighlight.tagName || '';
                            
                            if (
                                className.includes('session') || 
                                className.includes('course') || 
                                className.includes('event') ||
                                className.includes('offer') ||
                                className.includes('booking') ||
                                className.includes('card') ||
                                className.includes('item') ||
                                className.includes('entry') ||
                                className.includes('slot') ||
                                className.includes('row') ||
                                tagName === 'LI' ||
                                tagName === 'TR' ||
                                tagName === 'ARTICLE' ||
                                (tagName === 'DIV' && (
                                    className.includes('bs-') ||
                                    className.includes('calendar') ||
                                    className.includes('schedule')
                                )) ||
                                (elementToHighlight.offsetHeight > 50 && elementToHighlight.offsetWidth > 100)
                            ) {
                                break;
                            }
                            elementToHighlight = elementToHighlight.parentElement;
                            attempts++;
                        }

                        // Fallback si pas trouvÃ©
                        if (elementToHighlight === item.element) {
                            let parent = item.element.parentElement;
                            while (parent && parent !== widgetElement) {
                                if (parent.offsetHeight > 30 && parent.offsetWidth > 80) {
                                    elementToHighlight = parent;
                                    break;
                                }
                                parent = parent.parentElement;
                            }
                        }

                        if (elementToHighlight && elementToHighlight !== widgetElement) {
                            elementToHighlight.style.border = `3px solid ${color.replace('0.3', '1')}`;
                            elementToHighlight.style.backgroundColor = color;
                            elementToHighlight.setAttribute('data-highlighted', establishment);
                            
                            addDebugLog(`ğŸ¨ SurlignÃ© ${establishment} #${index+1}: ${elementToHighlight.tagName}.${elementToHighlight.className}`, 'success');
                        }
                    }
                });
            });

            addDebugLog('âœ… Surlignage terminÃ© - vous devriez voir les Ã©lÃ©ments colorÃ©s', 'success');
            addDebugLog('ğŸ’¡ Cliquez Ã  nouveau pour enlever le surlignage', 'info');
        }

        function testNetworkRequests() {
            addDebugLog('ğŸŒ === TEST DES REQUÃŠTES RÃ‰SEAU ===', 'info');
            
            // Simuler une requÃªte vers l'API Bsport
            const testUrl = 'https://api.production.bsport.io/book/v1/offer/?company=553&establishments=1697';
            
            addDebugLog(`ğŸ“¡ Test de requÃªte vers: ${testUrl}`, 'info');
            
            fetch(testUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })
            .then(response => {
                addDebugLog(`âœ… RÃ©ponse reÃ§ue: ${response.status}`, 'success');
                return response.json();
            })
            .then(data => {
                addDebugLog('ğŸ“Š DonnÃ©es de test reÃ§ues:', 'success');
                addDebugData('Test API Response', data);
            })
            .catch(error => {
                addDebugLog(`âŒ Erreur rÃ©seau: ${error.message}`, 'error');
                addDebugLog('ğŸ’¡ Probablement un problÃ¨me CORS - normal pour un test direct', 'info');
            });
            
            // VÃ©rifier si les intercepteurs fonctionnent
            addDebugLog('ğŸ” Test des intercepteurs rÃ©seau...', 'info');
            addDebugLog('ğŸ“Š Intercepteurs configurÃ©s:', 'info');
                         addDebugLog(`  - XMLHttpRequest: ${window.XMLHttpRequest !== XMLHttpRequest ? 'ModifiÃ©' : 'Original'}`, 'info');
             addDebugLog(`  - fetch: ${window.fetch !== fetch ? 'ModifiÃ©' : 'Original'}`, 'info');
         }

         function monitorNetworkActivity() {
             addDebugLog('ğŸ‘ï¸ === SURVEILLANCE RÃ‰SEAU ACTIVÃ‰E ===', 'info');
             
             const initialCount = networkRequestCount;
             const initialTime = Date.now();
             
             // Surveiller pendant 10 secondes
             const monitorInterval = setInterval(() => {
                 const currentCount = networkRequestCount;
                 const timeSinceStart = Date.now() - initialTime;
                 const timeSinceLastRequest = Date.now() - lastRequestTime;
                 
                 addDebugLog(`ğŸ“Š Surveillance: ${currentCount - initialCount} nouvelles requÃªtes en ${Math.round(timeSinceStart/1000)}s`, 'info');
                 
                 if (timeSinceLastRequest > 5000 && currentCount === initialCount) {
                     addDebugLog('âš ï¸ AUCUNE NOUVELLE REQUÃŠTE dÃ©tectÃ©e!', 'warning');
                     addDebugLog('ğŸ’¡ Le widget pourrait utiliser un cache ou ne pas se recharger', 'warning');
                 }
                 
                 if (timeSinceStart > 10000) {
                     clearInterval(monitorInterval);
                     addDebugLog(`âœ… Surveillance terminÃ©e: ${currentCount - initialCount} requÃªtes au total`, 'info');
                 }
             }, 2000);
         }

        // Ancienne fonction handleFilterClick supprimÃ©e - utilise maintenant celle avec filtrage cÃ´tÃ© client
        // Anciennes fonctions de remontage supprimÃ©es - utilise maintenant le filtrage cÃ´tÃ© client

        // Note: Les fonctions applyFilterWithMultipleMethods, trySimpleRemount, tryCompleteDestruction 
        // ne sont plus utilisÃ©es car remplacÃ©es par applyClientSideFilter

        // Section supprimÃ©e - contenait du code dupliquÃ©/erronÃ©

        function checkIfFilterWorked() {
            const currentContent = document.getElementById('bsport-widget-debug')?.innerHTML || '';
            const hasChanged = currentContent !== previousWidgetContent && currentContent.length > 100;
            
            addDebugLog(`ğŸ” VÃ©rification du filtrage:`, 'info');
            addDebugLog(`ğŸ“ Longueur contenu actuel: ${currentContent.length}`, 'info');
            addDebugLog(`ğŸ“ Longueur contenu prÃ©cÃ©dent: ${previousWidgetContent.length}`, 'info');
            addDebugLog(`ğŸ”„ Contenu a changÃ©: ${hasChanged ? 'OUI' : 'NON'}`, hasChanged ? 'success' : 'warning');
            
            return hasChanged;
        }

        function trySimpleRemount(config) {
            return new Promise((resolve, reject) => {
                try {
                    addDebugLog('ğŸ”„ MÃ©thode 1: Remontage simple...', 'info');
                    
                    if (!window.BsportWidget) {
                        reject(new Error('BsportWidget non disponible'));
                        return;
                    }

                    // Sauvegarder le contenu actuel
                    saveWidgetContent();

                    // CrÃ©er nouvelle config
                    const newConfig = {...widgetConfig};
                    newConfig.config.calendar.establishments = config.establishments;
                    newConfig._timestamp = Date.now(); // Cache buster

                    addDebugLog('ğŸ“‹ Configuration prÃ©parÃ©e:', 'info');
                    addDebugData('Config pour mÃ©thode 1', newConfig);

                    // Remonter directement
                    window.BsportWidget.mount(newConfig);
                    addDebugLog('âœ… Remontage simple effectuÃ©', 'success');
                    
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        function tryCompleteDestruction(config) {
            return new Promise((resolve, reject) => {
                try {
                    isReloading = true; // Marquer comme en cours de reload
                    
                    addDebugLog('ğŸ”„ MÃ©thode 2: Destruction complÃ¨te...', 'info');
                    
                    const widgetElement = document.getElementById('bsport-widget-debug');
                    if (!widgetElement) {
                        reject(new Error('Ã‰lÃ©ment widget non trouvÃ©'));
                        return;
                    }

                    // Ã‰tape 1: Vider complÃ¨tement
                    addDebugLog('ğŸ—‘ï¸ Vidage complet du widget...', 'info');
                    widgetElement.innerHTML = `
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Rechargement en cours...</p>
                            <small>MÃ©thode 2: Destruction complÃ¨te</small>
                        </div>
                    `;

                    // Ã‰tape 2: Attendre puis recrÃ©er l'Ã©lÃ©ment
                    setTimeout(() => {
                        addDebugLog('ğŸ”§ RecrÃ©ation de l\'Ã©lÃ©ment...', 'info');
                        
                        // CrÃ©er un nouvel Ã©lÃ©ment
                        const newWidgetElement = document.createElement('div');
                        newWidgetElement.id = 'bsport-widget-debug';
                        newWidgetElement.className = 'widget-container';
                        
                        // Remplacer l'ancien Ã©lÃ©ment
                        widgetElement.parentNode.replaceChild(newWidgetElement, widgetElement);
                        
                        addDebugLog('âœ… Nouvel Ã©lÃ©ment crÃ©Ã©', 'success');

                        // Ã‰tape 3: Remonter avec la nouvelle config
                        setTimeout(() => {
                            try {
                                const newConfig = {...widgetConfig};
                                newConfig.config.calendar.establishments = config.establishments;
                                newConfig._forceReload = Date.now();
                                newConfig._method = 'destruction';

                                addDebugLog('ğŸ“‹ Remontage avec nouvelle config:', 'info');
                                addDebugData('Config pour mÃ©thode 2', newConfig);

                                window.BsportWidget.mount(newConfig);
                                addDebugLog('âœ… Widget remontÃ© aprÃ¨s destruction', 'success');

                                // Marquer la fin du reload
                                setTimeout(() => {
                                    isReloading = false;
                                    addDebugLog('ğŸ Reload terminÃ©', 'success');
                                    
                                    // VÃ©rifier le rÃ©sultat
                                    setTimeout(() => {
                                        if (checkIfFilterWorked()) {
                                            addDebugLog('âœ… MÃ©thode 2 a fonctionnÃ©!', 'success');
                                        } else {
                                            addDebugLog('âš ï¸ MÃ©thode 2 aussi Ã©chouÃ©e - Le widget Bsport peut avoir un cache trÃ¨s persistant', 'warning');
                                            addDebugLog('ğŸ’¡ Suggestion: Essayez de fermer/rouvrir la page ou videz le cache du navigateur', 'info');
                                        }
                                    }, 3000);
                                }, 2000);

                                resolve();
                            } catch (mountError) {
                                isReloading = false;
                                addDebugLog(`âŒ Erreur remontage mÃ©thode 2: ${mountError.message}`, 'error');
                                reject(mountError);
                            }
                        }, 1000);
                    }, 1000);

                } catch (error) {
                    isReloading = false;
                    reject(error);
                }
            });
        }

        function checkIfFilterWorked() {
            const currentContent = document.getElementById('bsport-widget-debug')?.innerHTML || '';
            const hasChanged = currentContent !== previousWidgetContent && currentContent.length > 100;
            
            addDebugLog(`ğŸ” VÃ©rification du filtrage:`, 'info');
            addDebugLog(`ğŸ“ Longueur contenu actuel: ${currentContent.length}`, 'info');
            addDebugLog(`ğŸ“ Longueur contenu prÃ©cÃ©dent: ${previousWidgetContent.length}`, 'info');
            addDebugLog(`ğŸ”„ Contenu a changÃ©: ${hasChanged ? 'OUI' : 'NON'}`, hasChanged ? 'success' : 'warning');
            
            return hasChanged;
        }

        function saveWidgetContent() {
            const widgetElement = document.getElementById('bsport-widget-debug');
            if (widgetElement) {
                previousWidgetContent = widgetElement.innerHTML;
                addDebugLog(`ğŸ’¾ Contenu sauvegardÃ© (${previousWidgetContent.length} caractÃ¨res)`, 'info');
            }
        }

        function compareWidgetContent() {
            const currentContent = document.getElementById('bsport-widget-debug')?.innerHTML || '';
            const hasChanged = currentContent !== previousWidgetContent;
            
            addDebugLog(`ğŸ” Comparaison du contenu:`, 'info');
            addDebugLog(`ğŸ“ Avant: ${previousWidgetContent.length} caractÃ¨res`, 'info');
            addDebugLog(`ğŸ“ AprÃ¨s: ${currentContent.length} caractÃ¨res`, 'info');
            addDebugLog(`ğŸ”„ Changement dÃ©tectÃ©: ${hasChanged ? 'OUI' : 'NON'}`, hasChanged ? 'success' : 'warning');
            
            return hasChanged;
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            debugOutput = document.getElementById('debugOutput');
            
            addDebugLog('ğŸš€ Initialisation du debug temps rÃ©el...', 'info');
            addDebugLog('ğŸ“‹ Configuration des salles chargÃ©e:', 'info');
            
            Object.keys(sallesConfig).forEach(key => {
                const config = sallesConfig[key];
                addDebugLog(`  - ${key}: ${config.name} [${config.establishments.join(', ')}]`, 'info');
            });
            
            // Configurer l'interception rÃ©seau
            setupNetworkInterception();
            
            // Configurer les boutons de filtre avec debug
            addDebugLog('ğŸ”§ Configuration des Ã©vÃ©nements des boutons...', 'info');
            const filterButtons = document.querySelectorAll('.filter-btn');
            addDebugLog(`ğŸ“Š ${filterButtons.length} boutons de filtre trouvÃ©s`, 'info');
            
            filterButtons.forEach((btn, index) => {
                const filterKey = btn.getAttribute('data-filter');
                const buttonText = btn.textContent.trim();
                addDebugLog(`  ${index + 1}. Bouton: "${buttonText}" â†’ filterKey: "${filterKey}"`, 'info');
                
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    addDebugLog(`ğŸ–±ï¸ CLIC DÃ‰TECTÃ‰ sur bouton: "${buttonText}"`, 'success');
                    const filterKey = e.target.getAttribute('data-filter');
                    addDebugLog(`ğŸ“‹ Data-filter extrait: "${filterKey}"`, 'info');
                    
                    if (!filterKey) {
                        addDebugLog('âŒ Aucun data-filter trouvÃ©!', 'error');
                        return;
                    }
                    
                    handleFilterClick(filterKey);
                });
                
                addDebugLog(`âœ… Ã‰vÃ©nement attachÃ© pour: ${buttonText}`, 'success');
            });
            
            addDebugLog('âœ… Tous les Ã©vÃ©nements des boutons configurÃ©s', 'success');
            
            // Attendre BsportWidget
            const checkBsportWidget = () => {
                if (window.BsportWidget) {
                    addDebugLog('âœ… BsportWidget dÃ©tectÃ©!', 'success');
                    updateStatus('widgetStatus', 'Widget chargÃ©');
                    
                    // Monter le widget initial
                    try {
                        window.BsportWidget.mount(widgetConfig);
                        addDebugLog('âœ… Widget initial montÃ©', 'success');
                        updateStatus('widgetStatus', 'Widget actif');
                        
                        // Masquer le loading
                        const loading = document.querySelector('.loading');
                        if (loading) loading.style.display = 'none';
                        
                        // Lancer l'analyse automatique aprÃ¨s 2 secondes
                        setTimeout(() => {
                            addDebugLog('ğŸ” Lancement de l\'analyse automatique...', 'info');
                            runManualAnalysis();
                        }, 2000);
                        
                    } catch (e) {
                        addDebugLog(`âŒ Erreur montage: ${e.message}`, 'error');
                    }
                } else {
                    setTimeout(checkBsportWidget, 100);
                }
            };
            
            checkBsportWidget();
        });

        // Fonctions utilitaires pour la console du navigateur
        function MountBsportWidget(config) {
            if (window.BsportWidget) {
                window.BsportWidget.mount(config);
            }
        }
    </script>
</body>
</html> 